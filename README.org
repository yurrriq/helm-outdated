* helm-outdated

#+BEGIN_SRC yaml :tangle plugin.yaml
name: outdated
version: 0.0.2
usage: list outdated subcharts
description: |-
  List outdated subcharts.
command: "$HELM_PLUGIN_DIR/outdated.sh"
#+END_SRC


#+BEGIN_SRC bash :shebang "#! /usr/bin/env nix-shell" :tangle outdated.sh
#! nix-shell --pure -i bash -p gawk kubernetes-helm yq

set -euo pipefail


while IFS= read -r dependency
do
    subchart="${dependency%-*}"
    current="${dependency##*-}"
    latest=$(helm inspect chart "$subchart" | yq -r '.version')

    if [ "$current" == "$latest" ]
    then
        printf "%s is up to date.\\n" "$subchart"
    else
        printf "Consider upgrading %s: %s -> %s.\\n" \
               "$subchart" "$current" "$latest"
    fi
done < <(helm dep list | tail -n+2 | head -n-1 | sort -u | \
             awk '{ sub("@","",$3); printf "%s/%s-%s\n", $3, $1, $2; }')
#+END_SRC

# Local Variables:
# org-src-preserve-indentation: t
# End:
