* helm-outdated

** Metadata
#+BEGIN_SRC yaml :tangle plugin.yaml
name: outdated
version: 0.0.3
usage: list outdated subcharts
description: |-
  A Helm plugin to list outdated subcharts
command: "$HELM_PLUGIN_DIR/outdated.sh"
#+END_SRC

** Script
   :PROPERTIES:
   :header-args: :tangle outdated.sh
   :END:

Set the interpreter to Bash, and include the [[https://www.gnu.org/software/gawk/][GNU awk]], [[https://helm.sh/][Helm]], and [[https://yq.readthedocs.io/][yq]] packages.
#+BEGIN_SRC bash :shebang "#! /usr/bin/env nix-shell"
#! nix-shell --pure -i bash -p gawk kubernetes-helm yq
#+END_SRC

Be safer.
#+BEGIN_SRC bash
set -euo pipefail
#+END_SRC

Iterate through each dependency, and determine if it's outdated.
#+BEGIN_SRC bash
while IFS= read -r dependency
do
    subchart="${dependency%-*}"
    current="${dependency##*-}"
    latest=$(helm inspect chart "$subchart" | yq -r '.version')

    if [ "$current" == "$latest" ]
    then
        printf "%s is up to date.\\n" "$subchart"
    else
        printf "Consider upgrading %s: %s -> %s.\\n" \
               "$subchart" "$current" "$latest"
    fi
done < <(helm dep list | \
             grep -v WARNING | \
             tail -n+2 | head -n-1 | sort -u | \
             awk '{ sub("@","",$3); printf "%s/%s-%s\n", $3, $1, $2; }')
#+END_SRC

# Local Variables:
# org-src-preserve-indentation: t
# End:
